<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>OAuth2 Client Credentials Grant Test</title>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; line-height: 1.6; }
    .container { background: #f8f9fa; padding: 20px; border-radius: 8px; margin: 20px 0; }
    .success { background: #d4edda; border-left: 4px solid #28a745; }
    .error { background: #f8d7da; border-left: 4px solid #dc3545; }
    .info { background: #d1ecf1; border-left: 4px solid #17a2b8; }
    button { background: #007cba; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; margin: 5px; }
    button:hover { background: #005a87; }
    input[type="text"], input[type="password"] { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; margin: 5px 0; }
    pre { background: #f1f1f1; padding: 15px; border-radius: 4px; overflow-x: auto; }
    .config-section { background: #fff; border: 1px solid #ddd; padding: 15px; border-radius: 4px; margin: 10px 0; }
  </style>
</head>
<body>
  <h1>OAuth2 Client Credentials Grant Test</h1>

  <div class="config-section">
    <h3>Configuration</h3>
    <label>
      WordPress Base URL:
      <input type="text" id="baseUrl" value="http://localhost:8080" placeholder="http://your-wordpress-site.com" />
    </label>
    <label>
      Client ID:
      <input type="text" id="clientId" value="6sGbnXxlMT6svtaqKoiyRq61DgDasJH8" placeholder="Your OAuth2 Client ID" />
    </label>
    <label>
      Client Secret:
      <input type="password" id="clientSecret" value="fJjlT5S9oWmJsbhihKtzQprieyFftXimP5NhadpmkuAPXcGnwRVABwXkfmkI2L7h" placeholder="Your OAuth2 Client Secret" />
    </label>
    <label>
      Scope (optional, space-separated):
      <input type="text" id="scope" value="read" placeholder="read write" />
    </label>
  </div>

  <div class="container">
    <h3>Request Access Token (Client Credentials)</h3>
    <p>This will POST to <code>/oauth2/token</code> with <code>grant_type=client_credentials</code>.</p>
    <button onclick="requestClientCredentialsToken()">Request Token</button>
    <button onclick="clearStoredToken()">Clear Stored Token</button>
    <div id="tokenStatus" style="margin-top:10px;"></div>
  </div>

  <div id="results"></div>

  <script>
    function showBox(type, title, messageOrData) {
      const results = document.getElementById('results');
      const container = document.createElement('div');
      container.className = `container ${type}`;
      const content = typeof messageOrData === 'string' ? `<p>${messageOrData}</p>` : `<pre>${JSON.stringify(messageOrData, null, 2)}</pre>`;
      container.innerHTML = `<h3>${title}</h3>${content}`;
      results.appendChild(container);
    }

    function showError(msg) { showBox('error', 'Error', msg); }
    function showInfo(msg) { showBox('info', 'Info', msg); }
    function showResult(title, data) { showBox('success', title, data); }

    function updateTokenStatus() {
      const access = localStorage.getItem('cc_access_token');
      const expires = localStorage.getItem('cc_expires_in');
      const el = document.getElementById('tokenStatus');
      if (!el) return;
      if (access) {
        el.innerHTML = `<strong>Stored Token:</strong><br>access_token: present<br>expires_in: ${expires || 'n/a'}`;
      } else {
        el.innerHTML = '<em>No client-credentials access token stored.</em>';
      }
    }

    async function requestClientCredentialsToken() {
      try {
        const baseUrl = document.getElementById('baseUrl').value.trim();
        const clientId = document.getElementById('clientId').value.trim();
        const clientSecret = document.getElementById('clientSecret').value.trim();
        const scope = document.getElementById('scope').value.trim();

        if (!baseUrl || !clientId) {
          showError('Please fill in Base URL and Client ID');
          return;
        }

        const tokenEndpoint = baseUrl.replace(/\/$/, '') + '/oauth2/token';

        // Option A (body): Send client_id and client_secret in form body (simpler for this test page).
        const params = new URLSearchParams({
          grant_type: 'client_credentials',
          client_id: clientId
        });
        if (clientSecret) params.set('client_secret', clientSecret);
        if (scope) params.set('scope', scope);

        const response = await fetch(tokenEndpoint, {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body: params
        });

        if (!response.ok) {
          const error = await response.json().catch(() => ({}));
          throw new Error(error.error_description || error.error || `HTTP ${response.status}`);
        }

        const data = await response.json();
        if (data.access_token) localStorage.setItem('cc_access_token', data.access_token);
        if (data.expires_in) localStorage.setItem('cc_expires_in', String(data.expires_in));
        updateTokenStatus();
        showResult('Client Credentials Token Response', data);
      } catch (err) {
        showError('Token request failed: ' + err.message);
      }
    }

    function clearStoredToken() {
      localStorage.removeItem('cc_access_token');
      localStorage.removeItem('cc_expires_in');
      updateTokenStatus();
      showInfo('Stored client-credentials token cleared');
    }

    // Persist config values
    document.addEventListener('input', function(e) {
      if (e.target.id === 'baseUrl') {
        localStorage.setItem('cc_base_url', e.target.value);
      } else if (e.target.id === 'clientId') {
        localStorage.setItem('cc_client_id', e.target.value);
      } else if (e.target.id === 'clientSecret') {
        localStorage.setItem('cc_client_secret', e.target.value);
      } else if (e.target.id === 'scope') {
        localStorage.setItem('cc_scope', e.target.value);
      }
    });

    // Load persisted config
    window.addEventListener('load', function() {
      const baseUrl = localStorage.getItem('cc_base_url');
      const clientId = localStorage.getItem('cc_client_id');
      const clientSecret = localStorage.getItem('cc_client_secret');
      const scope = localStorage.getItem('cc_scope');
      if (baseUrl) document.getElementById('baseUrl').value = baseUrl;
      if (clientId) document.getElementById('clientId').value = clientId;
      if (clientSecret) document.getElementById('clientSecret').value = clientSecret;
      if (scope) document.getElementById('scope').value = scope;
      updateTokenStatus();
    });
  </script>
</body>
</html>
