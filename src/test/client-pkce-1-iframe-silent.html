<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Silent Login Handler</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            padding: 20px;
            text-align: center;
            background-color: #f8f9fa;
        }
        .status {
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .loading {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
    </style>
</head>
<body>
    <h2>Silent Login Handler</h2>
    <div id="status" class="status loading">
        Processing silent login...
    </div>

    <script>
        // Handle OAuth callback for silent login
        function handleSilentCallback() {
            try {
                const urlParams = new URLSearchParams(window.location.search);
                const code = urlParams.get('code');
                const state = urlParams.get('state');
                const error = urlParams.get('error');
                const errorDescription = urlParams.get('error_description');

                const statusEl = document.getElementById('status');

                if (error) {
                    // Handle OAuth error
                    statusEl.className = 'status error';
                    statusEl.innerHTML = `
                        <h3>Silent Login Failed</h3>
                        <p>Error: ${error}</p>
                        ${errorDescription ? `<p>Description: ${errorDescription}</p>` : ''}
                    `;

                    // Send error message to parent window
                    const message = {
                        type: 'SILENT_LOGIN_ERROR',
                        error: error,
                        error_description: errorDescription
                    };

                    // Try to send to parent window
                    if (window.parent && window.parent !== window) {
                        window.parent.postMessage(message, '*');
                    }

                } else if (code) {
                    // Handle successful authorization
                    statusEl.className = 'status success';
                    statusEl.innerHTML = `
                        <h3>Silent Login Successful</h3>
                        <p>Authorization code received. Sending to parent window...</p>
                    `;

                    // Send success message to parent window
                    const message = {
                        type: 'SILENT_LOGIN_SUCCESS',
                        code: code,
                        state: state
                    };

                    // Try to send to parent window
                    if (window.parent && window.parent !== window) {
                        window.parent.postMessage(message, '*');
                    }

                } else {
                    // No code or error - unexpected state
                    statusEl.className = 'status error';
                    statusEl.innerHTML = `
                        <h3>Unexpected Response</h3>
                        <p>No authorization code or error received.</p>
                    `;

                    // Send error message to parent window
                    const message = {
                        type: 'SILENT_LOGIN_ERROR',
                        error: 'unexpected_response',
                        error_description: 'No authorization code or error received'
                    };

                    // Try to send to parent window
                    if (window.parent && window.parent !== window) {
                        window.parent.postMessage(message, '*');
                    }
                }

            } catch (err) {
                console.error('Error handling silent callback:', err);
                
                const statusEl = document.getElementById('status');
                statusEl.className = 'status error';
                statusEl.innerHTML = `
                    <h3>Processing Error</h3>
                    <p>Error: ${err.message}</p>
                `;

                // Send error message to parent window
                const message = {
                    type: 'SILENT_LOGIN_ERROR',
                    error: 'processing_error',
                    error_description: err.message
                };

                // Try to send to parent window
                if (window.parent && window.parent !== window) {
                    window.parent.postMessage(message, '*');
                }
            }
        }

        // Run when page loads
        window.addEventListener('load', handleSilentCallback);

        // Also handle hash-based OAuth responses (if needed)
        if (window.location.hash) {
            const hashParams = new URLSearchParams(window.location.hash.substring(1));
            const accessToken = hashParams.get('access_token');
            const error = hashParams.get('error');

            if (accessToken || error) {
                // Handle hash-based response
                const message = {
                    type: error ? 'SILENT_LOGIN_ERROR' : 'SILENT_LOGIN_SUCCESS',
                    access_token: accessToken,
                    error: error,
                    error_description: hashParams.get('error_description')
                };

                if (window.parent && window.parent !== window) {
                    window.parent.postMessage(message, '*');
                }
            }
        }
    </script>
</body>
</html>
