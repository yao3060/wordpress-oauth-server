#!/usr/bin/env bash
set -aeuo pipefail

source .env

# set COMPOSE_PROJECT_NAME environment variable that will be used by the networks
COMPOSE_PROJECT_NAME="${PROJECT}_${ENVIRONMENT}"

# 解析命令行参数
CLEAN_MODE=false
for arg in "$@"; do
    case $arg in
        -c|--clean)
            CLEAN_MODE=true
            shift
            ;;
        *)
            echo "Usage: $0 [-c|--clean]"
            echo "  No arguments: Stop services only"
            echo "  -c, --clean: Stop services and remove related files (images, volumes, orphans)"
            exit 1
            ;;
    esac
done

echo "STOP ${COMPOSE_PROJECT_NAME}"

if [ "$CLEAN_MODE" = true ]; then
    echo "停止服务并删除相关文件..."
    docker compose down --rmi local --volumes --remove-orphans
    # docker rmi -f $(docker images --filter reference="${CONTAINER_REGISTRY}/*" -q) 2> /dev/null || true
else
    echo "仅停止服务..."
    docker compose down
fi
